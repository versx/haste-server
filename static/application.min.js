var haste_document=function(t){this.locked=!1,this.app=t};haste_document.prototype.htmlEscape=function(t){return t.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},haste_document.prototype.load=function(t,e,n){var o=this,s=this.app.selectedLines;$.ajax(o.app.baseUrl+"documents/"+t,{type:"get",dataType:"json",success:function(i){o.locked=!0,o.key=t,o.data=i.data;try{for(var a={value:"",language:null},l=i.data.split("\n"),r=0;r<l.length;r++){if("txt"===n)highlighted=o.htmlEscape(i.data);else if(n)highlighted=hljs.highlight(n,l[r]).value;else{var c=hljs.highlightAuto(l[r]);a.language=c.language,highlighted=c.value}var u=r+1,h="";u>=s.startLine&&u<=s.endLine&&(h="lineHighlight"),highlighted="<span id='line-"+(r+1)+"' class="+h+">"+highlighted+"</span>",a.value+=highlighted+"\n"}setTimeout(function(){s.startLine>=3?document.body.scrollTo(0,$("#line-"+(s.startLine-2)).offset().top):document.body.scrollTo(0,0)},0)}catch(t){a=hljs.highlightAuto(i.data)}e({value:a.value,key:t,language:a.language||n,lineCount:i.data.split("\n").length})},error:function(){e(!1)}})},haste_document.prototype.save=function(t,e){if(this.locked)return!1;this.data=t;var n=this;$.ajax(n.app.baseUrl+"documents",{type:"post",data:t,dataType:"json",contentType:"text/plain; charset=utf-8",success:function(o){n.locked=!0,n.key=o.key;var s=hljs.highlightAuto(t);e(null,{value:s.value,key:o.key,language:s.language,lineCount:t.split("\n").length})},error:function(t){try{e($.parseJSON(t.responseText))}catch(t){e({message:"Something went wrong!"})}}})};var haste=function(t,e){this.appName=t,this.$textarea=$("textarea"),this.$box=$("#box"),this.$code=$("#box code"),this.$linenos=$("#linenos"),this.options=e,this.configureShortcuts(),this.configureButtons(),e.twitter||$("#box2 .twitter").hide(),this.baseUrl=e.baseUrl||"/",this.selectedLines=e.selectedLines};haste.prototype.setTitle=function(t){var e=t?this.appName+" - "+t:this.appName;document.title=e},haste.prototype.showMessage=function(t,e){var n=$('<li class="'+(e||"info")+'">'+t+"</li>");$("#messages").prepend(n),setTimeout(function(){n.slideUp("fast",function(){$(this).remove()})},3e3)},haste.prototype.lightKey=function(){this.configureKey(["new","save"])},haste.prototype.fullKey=function(){this.configureKey(["new","duplicate","twitter","raw"])},haste.prototype.configureKey=function(t){var e,n=0;$("#box2 .function").each(function(){for(e=$(this),n=0;n<t.length;n++)if(e.hasClass(t[n]))return e.addClass("enabled"),!0;e.removeClass("enabled")})},haste.prototype.newDocument=function(t){this.$box.hide(),this.doc=new haste_document(this),t||window.history.pushState(null,this.appName,this.baseUrl),this.setTitle(),this.lightKey(),this.$textarea.val("").show("fast",function(){this.focus()}),this.removeLineNumbers()},haste.extensionMap={rb:"ruby",py:"python",pl:"perl",php:"php",scala:"scala",go:"go",xml:"xml",html:"xml",htm:"xml",css:"css",js:"javascript",vbs:"vbscript",lua:"lua",pas:"delphi",java:"java",cpp:"cpp",cc:"cpp",m:"objectivec",vala:"vala",sql:"sql",sm:"smalltalk",lisp:"lisp",ini:"ini",diff:"diff",bash:"bash",sh:"bash",tex:"tex",erl:"erlang",hs:"haskell",md:"markdown",txt:"",coffee:"coffee",swift:"swift"},haste.prototype.lookupExtensionByType=function(t){for(var e in haste.extensionMap)if(haste.extensionMap[e]===t)return e;return t},haste.prototype.lookupTypeByExtension=function(t){return haste.extensionMap[t]||t},haste.prototype.addLineNumbers=function(t){var e=document.getElementById("linenos");e.innerHTML="";for(var n=0;n<t;n++){var o=document.createElement("span");o.id="line-number-"+(n+1),o.textContent=n+1,o.addEventListener("mouseenter",function(t){return function(){handleMouseEnter(t)}}(n)),o.addEventListener("mouseleave",function(t){return function(){handleMouseLeave(t)}}(n)),o.addEventListener("mousedown",function(t){return function(){handleMouseDown(t)}}(n)),o.addEventListener("mouseup",function(t){return function(){handleMouseUp(t)}}(n)),e.appendChild(o),e.appendChild(document.createElement("br"))}},haste.prototype.removeLineNumbers=function(){$("#linenos").html("&gt;")},haste.prototype.loadDocument=function(t){var e=t.split(".",2),n=this;n.doc=new haste_document(this),n.doc.load(e[0],function(t){t?(n.$code.html(t.value),n.setTitle(t.key),n.fullKey(),n.$textarea.val("").hide(),n.$box.show().focus(),n.addLineNumbers(t.lineCount)):n.newDocument()},this.lookupTypeByExtension(e[1]))},haste.prototype.duplicateDocument=function(){if(this.doc.locked){var t=this.doc.data;this.newDocument(),this.$textarea.val(t)}},haste.prototype.lockDocument=function(){var t=this;this.doc.save(this.$textarea.val(),function(e,n){if(e)t.showMessage(e.message,"error");else if(n){t.$code.html(n.value),t.setTitle(n.key);var o=t.baseUrl+n.key;n.language&&(o+="."+t.lookupExtensionByType(n.language)),window.history.pushState(null,t.appName+"-"+n.key,o),t.fullKey(),t.$textarea.val("").hide(),t.$box.show().focus(),t.addLineNumbers(n.lineCount);var s=window.location.href;t.loadDocument(s.split("#")[0].split("/").slice(-1)[0])}})},haste.prototype.configureButtons=function(){var t=this;this.buttons=[{$where:$("#box2 .save"),label:"Save",shortcutDescription:"control + s",shortcut:function(t){return t.ctrlKey&&83===t.keyCode},action:function(){""!==t.$textarea.val().replace(/^\s+|\s+$/g,"")&&t.lockDocument()}},{$where:$("#box2 .new"),label:"New",shortcut:function(t){return t.ctrlKey&&78===t.keyCode},shortcutDescription:"control + n",action:function(){t.newDocument(!t.doc.key)}},{$where:$("#box2 .duplicate"),label:"Duplicate & Edit",shortcut:function(e){return t.doc.locked&&e.ctrlKey&&68===e.keyCode},shortcutDescription:"control + d",action:function(){t.duplicateDocument()}},{$where:$("#box2 .raw"),label:"Just Text",shortcut:function(t){return t.ctrlKey&&t.shiftKey&&82===t.keyCode},shortcutDescription:"control + shift + r",action:function(){window.location.href=t.baseUrl+"raw/"+t.doc.key}},{$where:$("#box2 .twitter"),label:"Twitter",shortcut:function(e){return t.options.twitter&&t.doc.locked&&e.shiftKey&&e.ctrlKey&&84==e.keyCode},shortcutDescription:"control + shift + t",action:function(){window.open("https://twitter.com/share?url="+encodeURI(window.location.href))}}];for(var e=0;e<this.buttons.length;e++)this.configureButton(this.buttons[e])},haste.prototype.configureButton=function(t){t.$where.click(function(e){e.preventDefault(),!t.clickDisabled&&$(this).hasClass("enabled")&&t.action()}),t.$where.mouseenter(function(){$("#box3 .label").text(t.label),$("#box3 .shortcut").text(t.shortcutDescription||""),$("#box3").show(),$(this).append($("#pointer").remove().show())}),t.$where.mouseleave(function(){$("#box3").hide(),$("#pointer").hide()})},haste.prototype.configureShortcuts=function(){var t=this;$(document.body).keydown(function(e){for(var n,o=0;o<t.buttons.length;o++)if((n=t.buttons[o]).shortcut&&n.shortcut(e))return e.preventDefault(),void n.action()})},$(function(){$("textarea").keydown(function(t){if(9===t.keyCode){t.preventDefault();if(document.selection)this.focus(),document.selection.createRange().text="  ",this.focus();else if(this.selectionStart||"0"==this.selectionStart){var e=this.selectionStart,n=this.selectionEnd,o=this.scrollTop;this.value=this.value.substring(0,e)+"  "+this.value.substring(n,this.value.length),this.focus(),this.selectionStart=e+"  ".length,this.selectionEnd=e+"  ".length,this.scrollTop=o}else this.value+="  ",this.focus()}})});